<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ—Å—Ç—É–ø–Ω–æ–µ IPTV | –í—Ö–æ–¥ –∏ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</title>
    
    <meta property="og:title" content="–î–æ—Å—Ç—É–ø–Ω–æ–µ IPTV | –í—Ö–æ–¥ –∏ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" />
    <meta property="og:description" content="4000 –∫–∞–Ω–∞–ª–æ–≤ IPTV –≤ –æ—Ç–ª–∏—á–Ω–æ–º –∫–∞—á–µ—Å—Ç–≤–µ —Å –∞—Ä—Ö–∏–≤–æ–º. –í—Ö–æ–¥ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è." />
    <meta property="og:url" content="https://iptv-box.netlify.app/" />
    <meta property="og:image" content="https://iptv-box.netlify.app/client/iptv.png" />
    <meta property="og:type" content="website" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <link rel="icon" href="https://iptv-box.netlify.app/client/icon.ico">
    
    <style>
        :root {
            --system-blue: #007AFF;
            --system-gray-light: #F2F2F7;
            --system-green: #34C759;
            --system-red: #FF3B30;
            --system-purple: #5856D6;
            --blue-hover: #0056b3;
            --green-hover: #218838;
            --purple-hover: #4341A5;
            --qr-color: #333;
            --text-dark: #333;
            --text-light: #666;
            --system-orange: #FF9500;
            --orange-hover: #CC7700;
        }

        /* ... (–°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: #FFFFFF;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: #333;
            flex-direction: column;
            position: relative;
            overflow-x: hidden; 
        }

        .page-wrapper {
            width: 100%;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .main-content {
            max-width: 700px;
            text-align: center;
            padding: 20px;
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
            animation-delay: 0.2s;
        }

        /* ... (–ü—Ä–æ–ø—É—Å–∫ –æ—Å—Ç–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ —Å—Ç–∏–ª–µ–π, –æ–Ω–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å) ... */
        
        /* =================================================== */
        /* –ö–ù–û–ü–ö–ò –ù–ê–í–ò–ì–ê–¶–ò–ò */
        /* =================================================== */
        .channel-list-btn {
            display: inline-block;
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 18px 36px;
            background: var(--system-blue);
            color: white;
            font-size: 22px;
            font-weight: 700;
            border-radius: 10px;
            text-decoration: none;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .channel-list-btn:hover {
            background: var(--blue-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.5);
        }

        .admin-button-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 110;
        }

        .auth-buttons-container {
            position: fixed; 
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 110;
        }
        
        .auth-btn {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            background: var(--system-blue);
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease, opacity 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
            display: block; 
            opacity: 1;
            text-decoration: none;
        }
        .auth-btn:hover {
            background: var(--blue-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.5);
        }
        .auth-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.4);
        }

        .admin-btn {
            background-color: var(--system-purple);
            box-shadow: 0 4px 10px rgba(88, 86, 214, 0.4);
        }
        .admin-btn:hover {
            background-color: var(--purple-hover);
            box-shadow: 0 6px 15px rgba(88, 86, 214, 0.5);
        }
        
        #logoutBtn {
             background-color: var(--system-red) !important;
             box-shadow: 0 4px 10px rgba(255, 59, 48, 0.4) !important;
             transition: opacity 0.3s ease, background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
             display: none; 
             opacity: 0;
        }
        #logoutBtn:hover {
             background-color: #cc0000 !important;
             box-shadow: 0 6px 15px rgba(255, 59, 48, 0.5) !important;
        }
    </style>
</head>
<body>
    
    <div class="admin-button-container">
        <a href="https://iptv-box.netlify.app/admin" class="auth-btn admin-btn">–ê–¥–º–∏–Ω</a>
    </div>

    <div class="auth-buttons-container" id="authButtonsContainer">
        <button class="auth-btn" id="regBtn" onclick="openModal('registrationModal')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button class="auth-btn" id="loginBtnNav" onclick="openModal('loginModal')">–í—Ö–æ–¥</button>
        <button class="auth-btn" id="logoutBtn" onclick="logout()">–í—ã—Ö–æ–¥</button>
    </div>

    <div class="page-wrapper">
        <div id="mainPageContent">
            <div class="main-content" id="preAuthContent">
                <h1>–î–æ—Å—Ç—É–ø–Ω–æ–µ IPTV ‚Äî 4000 –∫–∞–Ω–∞–ª–æ–≤ IPTV –≤ –æ—Ç–ª–∏—á–Ω–æ–º –∫–∞—á–µ—Å—Ç–≤–µ —Å –∞—Ä—Ö–∏–≤–æ–º.</h1>
                <p>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å IPTV —Ç–µ–ª–µ–≤–∏–¥–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π –¥–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞–Ω–∞–ª—ã –≤ Full HD –∏ Ultra HD –∫–∞—á–µ—Å—Ç–≤–µ. –ü–ª–µ–π–ª–∏—Å—Ç IPTV —Ç–µ–ª–µ–≤–∏–¥–µ–Ω–∏—è –Ω–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç 4000 IPTV –∫–∞–Ω–∞–ª–æ–≤. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞–º –∏ –∂–µ–ª–∞–µ–º –í–∞–º –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                <button class="channel-list-btn" id="showChannelListBtn">–°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤</button>
            </div>

            <div class="how-to-connect-block" id="howToConnectBlock">
                <h2>–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å IPTV</h2>
                <div class="steps-container">
                    <div class="step-item">
                        <div class="step-number">1</div><div class="step-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
                        <div class="step-description">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É</div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">2</div><div class="step-title">–û–ø–ª–∞—Ç–∞</div>
                        <div class="step-description">–û–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">3</div><div class="step-title">–ü–ª–µ–π–ª–∏—Å—Ç</div>
                        <div class="step-description">–°–∫–∞—á–∞—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç</div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">4</div><div class="step-title">–ó–∞–≥—Ä—É–∑–∫–∞</div>
                        <div class="step-description">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç –≤ –í–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</div>
                    </div>
                </div>
            </div>
            
            <div class="where-it-works-block" id="whereItWorksBlock">
                <h2>–ì–¥–µ —Ä–∞–±–æ—Ç–∞–µ—Ç IPTV?</h2>
                <div class="devices-container">
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-box.netlify.app/assets/smartphone-call.png" alt="–°–º–∞—Ä—Ç—Ñ–æ–Ω"></div>
                        <div class="device-name">–ù–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–µ</div>
                    </div>
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-box.netlify.app/assets/computer-tablet.png" alt="–ü–ª–∞–Ω—à–µ—Ç"></div>
                        <div class="device-name">–ù–∞ –ø–ª–∞–Ω—à–µ—Ç–µ</div>
                    </div>
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-box.netlify.app/assets/tv-box.png" alt="–¢–í –ø—Ä–∏—Å—Ç–∞–≤–∫–∞"></div>
                        <div class="device-name">–ù–∞ –¢–í –ø—Ä–∏—Å—Ç–∞–≤–∫–µ</div>
                    </div>
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-box.netlify.app/assets/tv.png" alt="Smart TV"></div>
                        <div class="device-name">–ù–∞ Smart TV —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–µ</div>
                    </div>
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-box.netlify.app/assets/tv-tuner.png" alt="–°–ø—É—Ç–Ω–∏–∫–æ–≤—ã–π —Ç—é–Ω–µ—Ä"></div>
                        <div class="device-name">–ù–∞ —Å–ø—É—Ç–Ω–∏–∫–æ–≤–æ–º —Ç—é–Ω–µ—Ä–µ</div>
                    </div>
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-box.netlify.app/assets/laptop.png" alt="–ö–æ–º–ø—å—é—Ç–µ—Ä"></div>
                        <div class="device-name">–ù–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ –∏ –Ω–æ—É—Ç–±—É–∫–µ</div>
                    </div>
                </div>
            </div>

            <div class="post-auth-layout">
                <div id="playlistInfoPage" class="playlist-info-page">
                    <p class="client-greeting" id="clientNameGreeting"></p>
                    <h2 style="font-weight: 600;">–í–∞—à –ø–ª–µ–π–ª–∏—Å—Ç</h2> 
                    <p class="expiration-info" id="expirationMessage"></p>
                    <button id="getTestBtn" onclick="handleTestBtnClick()">–í–∑—è—Ç—å —Ç–µ—Å—Ç</button>
                    <p style="color: #666; margin-bottom: 25px;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∏–∂–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ IPTV-—Å–µ—Ä–≤–∏—Å—É –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</p>
                    <div class="playlist-link-box" id="finalPlaylistLink">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="playlist-info-actions">
                        <button id="copyLinkBtnPage" style="background: var(--system-blue);">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                        <button id="downloadLinkBtnPage" style="background: var(--system-green);">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</button>
                    </div>
                </div>
                <div id="paymentBlock" class="payment-block playlist-info-page">
                    <h2>–û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏</h2>
                    <p class="payment-amount">–û–ø–ª–∞—Ç–∏—Ç—å 150 –≥—Ä–Ω</p>
                    <div class="card-number-display" id="cardNumberDisplay">5168752084846610</div>
                    <button class="copy-card-btn" onclick="copyToClipboard('5168752084846610', event)">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä</button>
                    <p style="color: #666; margin-top: 20px; margin-bottom: 25px; font-size: 14px;">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã, —á—Ç–æ–±—ã –æ–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.</p>
                    <button class="submit-btn-modern payment-btn" onclick="alert('–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ!')">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</button>
                </div>
            </div>
        </div>
        
        <div id="channelListPage" style="display: none;">
            </div>
    </div>


    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('registrationModal')">&times;</span>
            <h1 style="text-align: center; margin-bottom: 20px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
            <form id="registrationForm" onsubmit="return false;">
                <div class="input-group-modern"><input type="text" id="clientName" required placeholder=" "><label for="clientName">–í–∞—à–µ –∏–º—è</label></div>
                <div class="input-group-modern"><input type="tel" id="clientPhone" required placeholder=" "><label for="clientPhone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label></div>
                <div class="input-group-modern"><input type="password" id="clientPassword" required placeholder=" "><label for="clientPassword">–ü–∞—Ä–æ–ª—å</label></div>
                <div class="input-group-modern"><input type="password" id="clientPasswordRepeat" required placeholder=" "><label for="clientPasswordRepeat">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label></div>
                <button type="submit" class="submit-btn-modern">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <div id="statusMessage" class="status-message"></div>
            </form>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('loginModal')">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">–í—Ö–æ–¥</h2>
            <form id="loginForm" onsubmit="return false;">
                <div class="input-group-modern"><input type="tel" id="loginPhone" required placeholder=" "><label for="loginPhone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label></div>
                <div class="input-group-modern"><input type="password" id="loginPassword" required placeholder=" "><label for="loginPassword">–ü–∞—Ä–æ–ª—å</label></div>
                <button type="submit" id="loginBtn" class="submit-btn-modern">–í–æ–π—Ç–∏</button>
            </form>
            <div id="loginStatusMessage" class="status-message"></div>
        </div>
    </div>
    
    <div id="testPlaylistModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('testPlaylistModal')">&times;</span>
            <h2>–í–∞—à —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–µ–π–ª–∏—Å—Ç</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 16px;">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∏–∂–µ –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ IPTV-—Å–µ—Ä–≤–∏—Å—É.</p>
            <div class="playlist-link-box" id="testPlaylistLinkBox"></div>
            <button id="copyTestLinkBtn" onclick="return false;">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            <div id="testStatusMessage" class="status-message"></div>
        </div>
    </div>
    <div id="expiredTestModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('expiredTestModal')">&times;</span>
            <h2>–¢–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω</h2>
            <p>–í–∞—à —Ç–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥ –∏—Å—Ç–µ–∫, –æ–ø–ª–∞—Ç–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É.</p>
            <button class="submit-btn-modern payment-btn" onclick="closeModal('expiredTestModal'); document.getElementById('paymentBlock').scrollIntoView({ behavior: 'smooth' });">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</button>
        </div>
    </div>
    
    <script>
        // =================================================================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–ò–∑–≤–ª–µ—á–µ–Ω–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Netlify)
        // =================================================================
        const BASE_URL = 'https://iptv-box.netlify.app/';
        const REPO_CONFIG = {
            owner: "kyiv14", repo: "moe-iptv", branch: "main",
            clientsFile: "public/clients.json",
            // –ü—É—Ç—å –∫ sample.m3u —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç /sample.m3u
            samplePlaylist: `${BASE_URL}sample.m3u`, 
            baseUrl: BASE_URL
        };
        
        // --- –ö–û–ù–°–¢–ê–ù–¢–´ TELEGRAM –∏ GITHUB --- (–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ ENV Netlify)
        const GITHUB_TOKEN_PART_1 = 'ghp_to27A4'; 
        const GITHUB_TOKEN_PART_2 = 'Q0SrXyfBANG1'; 
        const GITHUB_TOKEN_PART_3 = 'fxQvzyhhgwrn0rm1ra';
        const TELEGRAM_BOT_TOKEN = '8457795718:AAH60EaVEHhS2AM1YJy1CQUHt8NMN4d2z34';
        const TELEGRAM_CHAT_ID = '351875366';
        
        let currentClientData = null; 
        let currentPlaylistResult = null;
        let currentTestPlaylistResult = null; 
        
        function getGitHubToken() { return GITHUB_TOKEN_PART_1 + GITHUB_TOKEN_PART_2 + GITHUB_TOKEN_PART_3; }

        function getExpirationDays(paymentDate, months) {
            if (!paymentDate || !months) return "–¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç";
            const start = new Date(paymentDate);
            const durationMonths = parseInt(months, 10);
            if (isNaN(durationMonths) || durationMonths <= 0) return "–¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç";
            const expirationDate = new Date(start);
            expirationDate.setMonth(expirationDate.getMonth() + durationMonths);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            expirationDate.setHours(0, 0, 0, 0);
            const diffTime = expirationDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays > 0) return `–∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ ${diffDays} –¥–Ω.`;
            if (diffDays === 0) return "–∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —Å–µ–≥–æ–¥–Ω—è!";
            return `–∑–∞–∫–æ–Ω—á–∏–ª—Å—è ${Math.abs(diffDays)} –¥–Ω. –Ω–∞–∑–∞–¥`;
        }
        
        function isTestExpired(clientData) {
            if (!clientData || !clientData.test_end_date) {
                return false; 
            }
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const testEndDate = new Date(clientData.test_end_date);
            testEndDate.setHours(0, 0, 0, 0);

            return today.getTime() >= testEndDate.getTime();
        }

        function extractPhoneNumber(phone) { return phone.replace(/\D/g, '').slice(-10); }
        function openModal(modalId) { 
             const statusEl = document.getElementById(modalId === 'testPlaylistModal' ? 'testStatusMessage' : (modalId === 'loginModal' ? 'loginStatusMessage' : 'statusMessage'));
             if(statusEl) statusEl.style.display = 'none';
             document.getElementById(modalId).style.display = 'flex'; 
        }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        function showStatus(message, type, elementId = 'statusMessage') {
            const statusEl = document.getElementById(elementId);
            statusEl.innerHTML = message;
            statusEl.className = 'status-message ' + type;
            statusEl.style.display = 'block';
        }
        function copyToClipboard(text, event) {
            if(event) event.preventDefault();
            navigator.clipboard.writeText(text).then(() => {
                alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞: ' + text);
            }).catch(err => console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err));
            return false;
        }
        function forceDownload(url, filename) {
            fetch(url).then(response => response.blob()).then(blob => {
                const blobUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl; a.download = filename;
                document.body.appendChild(a); a.click();
                setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(blobUrl); }, 100);
            }).catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞:', error));
        }
        
        function logout() {
            currentClientData = null; currentPlaylistResult = null; currentTestPlaylistResult = null; 
            document.querySelector('.post-auth-layout').style.display = 'none';
            document.getElementById('preAuthContent').style.display = 'block';
            document.getElementById('howToConnectBlock').style.display = 'block';
            document.getElementById('whereItWorksBlock').style.display = 'block';
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.style.opacity = '0'; 
            setTimeout(() => {
                logoutBtn.style.display = 'none';
                ['regBtn', 'loginBtnNav'].forEach(id => {
                    const btn = document.getElementById(id);
                    btn.style.display = 'block';
                    btn.style.opacity = '1';
                });
            }, 300);
        }

        function showPlaylistPage() {
            ['preAuthContent', 'howToConnectBlock', 'whereItWorksBlock'].forEach(id => document.getElementById(id).style.display = 'none');
            document.querySelector('.post-auth-layout').style.display = 'flex';
            document.getElementById('playlistInfoPage').style.display = 'block';
            document.getElementById('paymentBlock').style.display = 'block';
            ['regBtn', 'loginBtnNav'].forEach(id => document.getElementById(id).style.display = 'none');
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.style.display = 'block';
            setTimeout(() => { logoutBtn.style.opacity = '1'; }, 100);
            
            document.getElementById('clientNameGreeting').textContent = `–ü—Ä–∏–≤–µ—Ç, ${currentClientData.name || '–ö–ª–∏–µ–Ω—Ç'}!`;
            document.getElementById('expirationMessage').textContent = `–í–∞—à —Ç–∞—Ä–∏—Ñ ${getExpirationDays(currentClientData.paymentDate, currentClientData.months)}.`;
            
            document.getElementById('finalPlaylistLink').textContent = currentPlaylistResult.isgdUrl;
            
            document.getElementById('copyLinkBtnPage').onclick = (e) => copyToClipboard(currentPlaylistResult.isgdUrl, e);
            
            const downloadUrl = `${REPO_CONFIG.baseUrl}${currentClientData.phone}.m3u`;
            document.getElementById('downloadLinkBtnPage').onclick = () => {
                window.open(downloadUrl, '_blank'); 
            };
        }

        async function getFileSha(filename) {
            const apiUrl = `https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${filename}`;
            try {
                const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Accept': 'application/vnd.github+json' } });
                if (response.ok) return (await response.json()).sha;
                if (response.status === 404) return null;
                throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ SHA: ${response.statusText}`);
            } catch (error) { console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ SHA:', error); return null; }
        }

        async function loadClientsFromGitHub() {
            const apiUrl = `https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.clientsFile}`;
            const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Accept': 'application/vnd.github.v3+json' } });
            if (response.ok) {
                const data = await response.json();
                const content = decodeURIComponent(escape(atob(data.content)));
                return { clients: JSON.parse(content) || [], sha: data.sha };
            }
            if (response.status === 404) return { clients: [], sha: null };
            throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.statusText}`);
        }

        async function updateClientData(client) {
            let { clients: currentClients, sha } = await loadClientsFromGitHub();
            const index = currentClients.findIndex(c => c.phone === client.phone);
            if (index === -1) throw new Error("–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.");
            
            currentClients[index] = client;
            
            const response = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.clientsFile}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github+json' },
                body: JSON.stringify({ message: `–û–±–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞: ${client.name} (—Ç–µ—Å—Ç)`, content: btoa(unescape(encodeURIComponent(JSON.stringify(currentClients)))), branch: REPO_CONFIG.branch, sha: sha })
            });
            if (!response.ok) throw new Error((await response.json()).message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞.");
            return true;
        }

        async function createIsGdShortUrl(phone, isTest = false) {
            const cleanPhone = extractPhoneNumber(phone);
            const shortUrlAlias = isTest ? `test${cleanPhone}` : cleanPhone;
            const longUrl = isTest 
                            ? `${REPO_CONFIG.baseUrl}api/playlist_link?phone=${cleanPhone}`
                            : `${REPO_CONFIG.baseUrl}${cleanPhone}.m3u`;
            
            try {
                const apiUrl = `https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}&shorturl=${shortUrlAlias}`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                return data.errorcode ? `https://is.gd/${shortUrlAlias}` : data.shorturl;
            } catch (error) { 
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è is.gd —Å—Å—ã–ª–∫–∏:', error); 
                return `https://is.gd/${shortUrlAlias}`;
            }
        }

        async function createTestPlaylist(phone) {
            const cleanPhone = extractPhoneNumber(phone);
            const filename = `public/test${cleanPhone}.m3u`;
            const key = '0000000000'; 
            
            const response = await fetch(REPO_CONFIG.samplePlaylist);
            if (!response.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—Ä–∞–∑–µ—Ü –ø–ª–µ–π–ª–∏—Å—Ç–∞ sample.m3u.");
            
            let content = await response.text();
            content = content.replace(/\/iptv\/\w+\//g, `/iptv/${key}/`);
            
            const sha = await getFileSha(filename);
            const uploadResponse = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${filename}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github+json' },
                body: JSON.stringify({ message: `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¢–ï–°–¢–û–í–û–ì–û –ø–ª–µ–π–ª–∏—Å—Ç–∞: ${cleanPhone}`, content: btoa(unescape(encodeURIComponent(content))), branch: REPO_CONFIG.branch, sha: sha })
            });
            
            if (!uploadResponse.ok) throw new Error((await uploadResponse.json()).message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞");
            
            const isgdUrl = await createIsGdShortUrl(phone, true); 
            return { isgdUrl, m3uFilename: `test${cleanPhone}.m3u`, m3uContent: content };
        }

        async function createPlaylist(phone, key) {
            const cleanPhone = extractPhoneNumber(phone);
            if (cleanPhone.length < 10) throw new Error("–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 10 —Ü–∏—Ñ—Ä.");
            
            const filename = `public/${cleanPhone}.m3u`;
            const response = await fetch(REPO_CONFIG.samplePlaylist);
            if (!response.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—Ä–∞–∑–µ—Ü –ø–ª–µ–π–ª–∏—Å—Ç–∞ sample.m3u.");
            
            let content = await response.text();
            content = content.replace(/\/iptv\/\w+\//g, `/iptv/${key}/`);
            
            const sha = await getFileSha(filename);
            const uploadResponse = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${filename}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github+json' },
                body: JSON.stringify({ message: `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞: ${cleanPhone}`, content: btoa(unescape(encodeURIComponent(content))), branch: REPO_CONFIG.branch, sha: sha })
            });
            
            if (!uploadResponse.ok) throw new Error((await uploadResponse.json()).message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞");
            
            const isgdUrl = await createIsGdShortUrl(phone, false); 
            return { isgdUrl, m3uFilename: `${cleanPhone}.m3u`, m3uContent: content };
        }
        
        async function sendRegistrationToTelegram(clientData) {
            const regDate = new Date(clientData.registration_date).toLocaleDateString('ru-RU', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            const message = `üîî –ù–û–í–ê–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø! üîî\n\n–ò–º—è: ${clientData.name}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${clientData.phone}\n–î–∞—Ç–∞: ${regDate}`;
            const apiUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(message)}&parse_mode=HTML`;
            
            try {
                await fetch(apiUrl, { method: 'POST' });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram:', error);
            }
        }

        async function saveClientData(client) {
            let { clients: currentClients, sha } = await loadClientsFromGitHub();
            if (currentClients.some(c => c.phone === client.phone)) throw new Error("–ö–ª–∏–µ–Ω—Ç —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.");
            currentClients.push(client);
            const response = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.clientsFile}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github+json' },
                body: JSON.stringify({ message: `–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç: ${client.name}`, content: btoa(unescape(encodeURIComponent(JSON.stringify(currentClients)))), branch: REPO_CONFIG.branch, sha: sha })
            });
            if (!response.ok) throw new Error((await response.json()).message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞.");
            return true;
        }
        
        async function handleTestBtnClick() {
            if (!currentClientData) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.');
                return;
            }
            
            if (isTestExpired(currentClientData)) {
                openModal('expiredTestModal');
                return;
            }
            
            try {
                if (!currentClientData.test_end_date) {
                    const today = new Date();
                    const endDate = new Date(today.getTime() + (3 * 24 * 60 * 60 * 1000));
                    currentClientData.test_end_date = endDate.toISOString().split('T')[0];
                    
                    await updateClientData(currentClientData);
                }
                
                currentTestPlaylistResult = await createTestPlaylist(currentClientData.phone);
                
                const linkBox = document.getElementById('testPlaylistLinkBox');
                const copyBtn = document.getElementById('copyTestLinkBtn');
                
                linkBox.textContent = currentTestPlaylistResult.isgdUrl;
                copyBtn.onclick = (e) => copyToClipboard(currentTestPlaylistResult.isgdUrl, e);
                
                document.getElementById('testStatusMessage').style.display = 'none';
                
                openModal('testPlaylistModal');
                
            } catch (error) {
                showStatus(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞: ${error.message}`, "error", 'testStatusMessage');
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            
            window.handleTestBtnClick = handleTestBtnClick; 
            
            document.getElementById('registrationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('clientName').value.trim();
                const phone = document.getElementById('clientPhone').value.trim();
                const password = document.getElementById('clientPassword').value;
                const passwordRepeat = document.getElementById('clientPasswordRepeat').value;
                const cleanPhoneDigits = extractPhoneNumber(phone);
                
                if (!name || !phone || !password || password !== passwordRepeat || password.length < 6 || cleanPhoneDigits.length < 10) {
                    showStatus("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª—è: –∑–∞–ø–æ–ª–Ω–µ–Ω—ã, –ø–∞—Ä–æ–ª–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç (–º–∏–Ω. 6 —Å–∏–º–≤.), —Ç–µ–ª–µ—Ñ–æ–Ω (–º–∏–Ω. 10 —Ü–∏—Ñ—Ä).", "error");
                    return;
                }
                const newClient = { name, phone: cleanPhoneDigits, password, key: '0000000000', paymentDate: new Date().toISOString().split('T')[0], months: '1', registration_date: new Date().toISOString() };
                try {
                    await sendRegistrationToTelegram(newClient);
                    
                    currentPlaylistResult = await createPlaylist(phone, newClient.key);
                    await saveClientData(newClient);
                    currentClientData = newClient;
                    
                    document.getElementById('registrationForm').reset();
                    closeModal('registrationModal');
                    document.getElementById('loginPhone').value = phone; 
                    document.getElementById('loginPassword').value = password; 
                    openModal('loginModal');
                } catch (error) { showStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, "error"); console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error); }
            });

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const loginPhone = document.getElementById('loginPhone').value.trim();
                const loginPassword = document.getElementById('loginPassword').value;
                const cleanLoginPhoneDigits = extractPhoneNumber(loginPhone);
                if (!loginPhone || !loginPassword) { showStatus('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.', "error", 'loginStatusMessage'); return; }
                try {
                    const { clients } = await loadClientsFromGitHub();
                    const client = clients.find(c => c.phone === cleanLoginPhoneDigits && c.password === loginPassword);
                    if (client) {
                        currentClientData = client;
                        currentPlaylistResult = await createPlaylist(loginPhone, client.key || '0000000000');
                        closeModal('loginModal');
                        showPlaylistPage();
                    } else { showStatus('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ –ø–∞—Ä–æ–ª—å.', "error", 'loginStatusMessage'); }
                } catch (error) { showStatus(`‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${error.message}`, "error", 'loginStatusMessage'); console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error); }
            });
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤
            document.getElementById('showChannelListBtn').addEventListener('click', function() {
                document.getElementById('mainPageContent').style.display = 'none';
                document.getElementById('channelListPage').style.display = 'block';
                document.getElementById('authButtonsContainer').style.display = 'none';
                document.querySelector('.admin-button-container').style.display = 'none';
            });
            document.getElementById('backToMainBtn').addEventListener('click', function() {
                document.getElementById('channelListPage').style.display = 'none';
                document.getElementById('mainPageContent').style.display = 'block';
                document.getElementById('authButtonsContainer').style.display = 'flex';
                document.querySelector('.admin-button-container').style.display = 'block';
            });
        });

        window.openModal = openModal;
        window.closeModal = closeModal;
        window.logout = logout;
    </script>
    
    <script>
        // =================================================================
        // –°–ö–†–ò–ü–¢ –î–õ–Ø –°–¢–†–ê–ù–ò–¶–´ –°–ü–ò–°–ö–ê –ö–ê–ù–ê–õ–û–í
        // =================================================================
        (function() {
            // –ü—É—Ç—å –∫ moe.m3u —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç /moe.m3u
            const url = `${BASE_URL}moe.m3u`; 
            const categoriesEl = document.getElementById('categories');
            const searchResultsEl = document.getElementById('search-results');
            const channelModal = document.getElementById('channelModal');
            const modalTitle = document.getElementById('modal-title');
            const channelList = document.getElementById('channel-list');
            const mainSearch = document.getElementById('main-search');
            const modalSearch = document.getElementById('modal-search');

            let dataByGroup = {};
            let allChannels = [];
            let allCategories = [];

            window.closeChannelModal = function() {
                channelModal.style.display = 'none';
            }

            async function fetchAndParseM3U() {
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const text = await res.text();
                    const lines = text.split('\n');
                    let currentInfo = '';
                    let currentGroup = '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line.startsWith('#EXTINF')) { currentInfo = line; } 
                        else if (line.startsWith('#EXTGRP')) { currentGroup = line.replace('#EXTGRP:', '').trim(); } 
                        else if (line && !line.startsWith('#')) {
                            const titleMatch = currentInfo.match(/,(.*)$/);
                            const title = titleMatch ? titleMatch[1] : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–Ω–∞–ª';
                            if (!dataByGroup[currentGroup]) dataByGroup[currentGroup] = [];
                            const channelData = { title, group: currentGroup, url: line };
                            dataByGroup[currentGroup].push(channelData);
                            allChannels.push(channelData);
                            currentGroup = '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                        }
                    }
                    allCategories = Object.keys(dataByGroup).sort();
                    renderCategories();
                } catch (error) {
                    console.error("Failed to fetch and parse M3U file:", error);
                    categoriesEl.innerHTML = "<p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>";
                }
            }

            function renderCategories() {
                categoriesEl.innerHTML = '';
                searchResultsEl.innerHTML = '';
                categoriesEl.style.display = 'grid';
                allCategories.forEach(group => {
                    const count = dataByGroup[group].length;
                    const el = document.createElement('div');
                    el.className = 'category';
                    el.innerHTML = `<div class="category-name">${group}</div><div class="category-count">–ö–∞–Ω–∞–ª–æ–≤: ${count}</div>`;
                    el.onclick = () => openChannelModal(group);
                    categoriesEl.appendChild(el);
                });
            }

            function openChannelModal(group) {
                modalTitle.textContent = group;
                channelList.innerHTML = '';
                dataByGroup[group].forEach(channel => {
                    const ch = document.createElement('div');
                    ch.className = 'channel';
                    ch.textContent = channel.title;
                    channelList.appendChild(ch);
                });
                channelModal.style.display = 'flex';
                modalSearch.value = '';
                modalSearch.focus();
                modalSearch.oninput = function() {
                    const searchTerm = this.value.toLowerCase();
                    channelList.querySelectorAll('.channel').forEach(channel => {
                        channel.style.display = channel.textContent.toLowerCase().includes(searchTerm) ? 'block' : 'none';
                    });
                };
            }

            mainSearch.oninput = function() {
                const searchTerm = this.value.toLowerCase().trim();
                if (searchTerm === '') { renderCategories(); return; }
                categoriesEl.style.display = 'none';
                searchResultsEl.innerHTML = '';
                const foundChannels = allChannels.filter(channel => channel.title.toLowerCase().includes(searchTerm));
                if (foundChannels.length === 0) {
                    searchResultsEl.innerHTML = '<div style="padding: 2rem; text-align: center; font-size: 1.2rem; color: var(--text-light);">–ö–∞–Ω–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }
                foundChannels.forEach(channel => {
                    const el = document.createElement('div');
                    el.className = 'channel-result';
                    el.innerHTML = `<div>${channel.title}</div><div class="channel-category">${channel.group}</div>`;
                    el.onclick = () => {
                        openChannelModal(channel.group);
                        setTimeout(() => {
                            channelList.querySelectorAll('.channel').forEach(ch => {
                                if (ch.textContent === channel.title) {
                                    ch.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    ch.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
                                    setTimeout(() => ch.style.backgroundColor = '', 2000);
                                }
                            });
                        }, 100);
                    };
                    searchResultsEl.appendChild(el);
                });
            };

            window.onclick = function(e) {
                if (e.target === channelModal) closeChannelModal();
            };
            window.onkeydown = function(e) {
                if (e.key === "Escape" && channelModal.style.display === 'flex') closeChannelModal();
            }
            fetchAndParseM3U();
        })();
    </script>
</body>
</html>